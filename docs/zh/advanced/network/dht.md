# 分布式哈希表（DHT）

在一个去中心化的网络中，我们需要解决三个关键问题：节点如何高效地发现彼此？数据应该保存在哪里？当用户请求某段数据时，网络该如何快速响应？DHT（Distributed Hash Table，分布式哈希表）正是应对这些挑战而出现的设计，它让网络中的每个节点既能便捷地保存数据，也能快速查询到任何数据的位置，不论网络规模有多大，查找速度都非常快。

## 基本原理

DHT 通过一种逻辑距离来组织网络中的节点。每个节点都重点维护那些距离自己更近的节点，而对距离较远的节点关注则较少。同理，数据会优先保存在那些与它 ID 接近的节点上，在查找和发送文件时只需要逐步找到这些节点。这样设计的最大好处是，网络的每个部分都能自适应扩展，不管网络有多大，数据总能在有限跳数内被高效查找。

### XOR 距离

在 DHT 里，距离不是现实世界的地理距离，而是通过 XOR（异或） 算法定义的逻辑距离。无论节点还是文件，都有一个唯一的 ID（通常用哈希生成），可以想象成一个 256 位的二进制数。XOR 距离的计算方式很简单：对于两个 ID，每一位相同得 0，不同得 1，最后得到的二进制就是它们的距离。举个例子：

- 节点 A 的 ID：10110011
- 节点 B 的 ID：11001011
- A XOR B = 01111000

这个结果越小，表示两个 ID 越相近。DHT 就是基于这种距离来决定节点和数据的归属关系。

### 路由表和 k-bucket

每个节点都维护着一张路由表，用于记录它所认识的其他节点信息。由于网络节点可能非常多，路由表不能无限大，所以采用了分层结构，也就是 **k-bucket**。

![image.png](/zh/k-bucket.png)

假设我们用 8 位二进制表示 ID，那么每一层就代表一段 XOR 距离范围。第 1 层是和我 XOR 距离在 $2^0$ 到 $2^1$ 之间的节点，第 2 层是 $2^1$ 到 $2^2$ ，依此类推。每一层都最多只保存 $k$ 个节点，以保持表的紧凑。不难发现，距离越远的层，覆盖的节点范围越大，所以高层的 k-bucket 可能包含更多不同的节点。

### 数据查找

当你需要上传或下载一份数据时，首先会根据数据的 ID 计算出应该由哪些节点来保存它。然后，你会在自己的路由表中，找到距离目标 ID 最近的节点，向他们发起查询请求。收到请求的节点会从自己的 k-bucket 里继续挑出距离更近的节点返回给你。如此迭代，查找请求会一跳跳“递进”接近目标，直到找到最终保存数据的节点。

这种方法本质上就是一种最近邻迭代查找：每次都向网络中更接近目标的节点靠近，直到命中为止。整个查找的复杂度是 $O(\log n)$，即使在成千上万节点的超大网络里，也能在很短时间内完成查找。

## 应用挑战

DHT 由于其弹性、自适应和高效查找的特性，一度被认为是 DAS 系统中节点发现和数据分发的理想底层。首先，DHT 的可扩展性极具吸引力。在 DAS 网络中，采样节点只需通过有限数量的查询，就能从上千甚至上万节点中高效定位和检索区块数据。这种对数复杂度查找能力极大缓解了传统全同步网络的带宽与存储压力，也为主网和二层扩容提供了理论基础。

但在实际落地过程中，研究与实践表明，DHT 在数据可用性网络中面临一系列新的挑战和权衡，其优势和局限都被进一步放大和暴露。

### 安全威胁被放大

在理论上，DHT 可以通过节点动态维护保证数据高可用。但一旦应用到高价值的 DAS 数据中，攻击者可以批量创建女巫节点，填充诚实节点的路由表，使部分采样数据永久丢失。密钥空间攻击和防御的成本十分不对等，因为攻击者可以将女巫节点分布在特定的密钥空间子集中。因此密钥空间攻击的代价极低，却足以让攻击者以极小成本破坏大面积数据可用性。

![image.png](/zh/sybil.png)

有一种可行的防御措施是验证链上身份，使用 ENS 或者少量的质押，从而增加攻击成本，不过攻击成本相对于整体链的安全性仍然非常小。

### 路径可预测与劫持攻击

DHT 每次查找时，都会向数个节点发起查询请求以获得更短路径，但有研究表明这些路径最终都会指向相同的少数节点。这些节点如果是攻击者控制的女巫节点，则可以轻易地阻断查询。如果这在采样完成之后发生，同样可以使得可用性数据不可用。

### 分发难题

虽然 DHT 的查询具备对数复杂度的效率，但在 DAS 应用环境下，数据需要在极短的时间内分发到目标节点，这将带来巨大的查询数量，这种大量并发查询极大限制了 DHT 的分发效率。有研究表明，即便数据量较小、网络健康，实际全网分发完成仍需分钟级别，这远远无法满足主网需求。另外，提升分发者的资源并不能缓解分发难题，因为查询会传递到分发者的邻居。

但如果分发者具有全局路由，将不需要经过查找的步骤直接分发数据，这又要求一个资源强大的分发者。

## 应用

由于 DHT 存在的这些挑战，加上 DAS 网络的设计需求逐渐清晰，当前 DAS 网络并没有直接使用 DHT 来存储可用性数据，而是使用其承担了节点发现与分布式索引的功能。但 DHT 的诸多良好的特性，依然 DAS 中网络层的替代方案。