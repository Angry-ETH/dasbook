# Gossip 协议与 GossipSub

想要在极短的时间内将一条消息传给成千上万的节点，只需要直接发送给你知道的所有节点，网络中的任何节点都按同样的方式传播，这类似于人类社会中的八卦，Gossip 协议正是模拟了这种传播机制。传统的 DHT 查询机制虽有明确的结构支持，却在这种广播机制方面显得力不从心，尤其是在数据可用性采样（DAS）这样对速度和可靠性要求极高的场景中。

但这份扩散也并非没有代价。传统 Gossip 协议无结构、冗余极高，带宽浪费严重，网络拓扑也难以控制。我们希望既能保留它快速传播的能力，又能实现精细化管理和高效协调。另外，我们需要一个更具结构性的网络拓扑，使其能够应用到 DAS 中，这就是 GossipSub 的用武之地。

GossipSub 是一种发布-订阅（pub/sub）协议。你可以将它想象为一个有组织的八卦网络：每个节点只关注自己感兴趣的话题（topics），并与对同话题感兴趣的一小部分其他节点连接。这种类似于子网的拓扑结构，正好可以映射 DAS 中的数据结构，实现了高效的数据传播。

在 DAS 网络中，GossipSub 当前已成为核心的通信协议。

## 网络结构

![image.png](/zh/gossipsub-network.png)

### Mesh 网络

订阅了某个特定 topic 的节点，会通过发现找到同样订阅该 topic 的节点，并与其建立连接，这些节点共同组成该 topic 的 mesh。当节点发布消息时，只需将其发送给少数已建立联系的对等点，他们再向自己的维护的对等点扩散，从而低消耗地在 mesh 内传播。

每个节点仅需维护少量连接，就能实现大范围的覆盖。为了保持连接质量，GossipSub 通过周期性的心跳机制自动执行 `GRAFT`（补足连接）和 `PRUNE`（修剪冗余），确保传播路径既稳定又灵活。

这是一种全消息（f**ull-message**）网络，即相互发送的消息是完整的，而非元数据。

### 仅元数据网络

从整个网络的视角来看，子网之间仍然需要交流。因此除了 full-message 传播之外，节点还维护一个紧密的仅元数据（metadata-only ）网络。这部分连接不传输完整消息内容，仅用于交换控制信令，包括：

- `IHAVE`：告诉邻居“我有某条消息”；
- `IWANT`：请求邻居发送某条缺失的消息；
- `IDONTWANT`：声明不希望收到某些消息，防止重复推送。

这套机制在高负载或链路不稳定时非常关键，它让每个节点都能在“只传需要的”前提下补齐丢失，节省带宽并提升鲁棒性。

### Fan-out

在某些情境下，节点需要向未订阅的 topic 发送完整消息。例如，我采样了一条数据，但并不在我的保管范围内。GossipSub 允许未订阅某个 topic 的节点也能临时发布消息，这是通过 fanout peers 机制来实现的：

- 节点初次向未订阅的 topic 发布消息时，会随机选取一批已订阅该 topic 的节点作为 fanout peers；
- 这些 fanout peers 接收消息并在 mesh 内扩散；
- fanout peers 是短期结构，若节点一段时间没有再发送该 topic 消息，将被自动清除。

为了避免消息泛滥，每条消息通常携带 TTL（Time-To-Live）字段，例如 5 表示最多传播 5 次，每转发一次则减少 1。

## DAS 应用

在 DAS 系统中，区块数据被编码为二维矩阵，每一行或列都对应一个逻辑 topic。数据发布者会将数据按照列或行广播到对应的 topic。

每个节点根据其负责的 custody 范围，选择订阅相关 topic，加入相应的 mesh 网络交换数据。并且在数据发布后：

- 节点使用 `IHAVE` 广播已持有的数据片段；
- 对其他节点缺失的部分，使用 `IWANT` 请求补齐；
- 若某些数据不感兴趣或已拥有，可使用 `IDONTWANT` 主动屏蔽，减少带宽浪费。

这些机制使得 DAS 网络在保证采样完整性的同时，具备良好的分发效率和扩展性。