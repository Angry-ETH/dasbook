# 椭圆曲线密码学

密码学建立在加密容易解密难的基础上，椭圆曲线加密发端于一个简单的乘法：

$$
P=hG
$$

即 $P$ 是 $h$ 和 $G$ 的乘积，这看起来平平无奇，平常我们很容易在计算器上完成乘法和除法。但我们能不能实现乘法很容易，但是除法很难？当我们知道 $h$ 和 $G$ 时，计算 $P$ 非常容易，而反过来知道  $P$ 和 $G$ 计算 $h$ 则被认为是不可能的。

## 椭圆曲线

现在我们就来“发明”这种数学，它是一个独立的小王国，对于“数字”和“加法”有着不同的理解。所有的数字，是一个一个特定的点构成的，这些点必须满足一定的条件：

$$
y^2 = x^3 + ax + b
$$

我们用几何图形来表示，这个曲线看起来像一个椭圆

![image.png](/zh/ecc1.png)

观察这个曲线，不难发现一些特性：

1. 它关于 $x$ 轴对称
2. 连接曲线上的两个点画一条直线，它会和曲线产生第三个交点

这些特征非常有用，非常方便我们定义加法：

- 若我们要计算 $A + B$ ，可以画一条直线连接点 $A$ 和 $B$ ；
- 这条直线会与椭圆曲线在第三个点 $C$ 相交。

有了三个元素，这就好办多了，我们可以将加法定义为： $A+B=C$ 。因为 $A$ 和 $B$ 在同一条直线上，因此我们还获得了加法交换律，即： $A+B=B+A$ ，但 $C$ 同样在这条直线上，即： $B+C=A$ ，以及 $A+C=B$ ，很明显这三个数都为 $0$ 才行，我们的小王国还没有建立就坍塌了。

我们还需要对 $C$ 做一次 $x$ 轴反射，得到的点记为 $R$，最终我们定义 $R = A + B$。

![image.png](/zh/ecc2.png)

对 $C$ 点做反射，还有一些更深远的意义。我们连接 $R$ 和 $C$ 将获得一条垂直于 $x$ 轴的直线，它和曲线看起来并无其他交点。换句话说，这条直线和椭圆曲线在无穷远处有一个交点，我们将这个无穷远处的点作为 $0$ ，因此有 $C+R=R+C=0$，以及 $A+B+C=0$ 。

另外还有一种特殊情况 $A=B$ , 这意味着 $A$ 点和 $B$ 点重合了，在几何意义上意味着这是一条切线。我们得到了 $A + A=R$ ，再次画出从 $R$ 经过 $A$ 的直线我们得到了 $A+A+A$ ，这种重复的加法，即为乘法：

$$
hA = \underbrace{A + A + \cdots + A}_{h}
$$

这与我们日常的乘法并没有太大差别，但它在椭圆曲线的定义下，遵循的是几何上的点加操作。而“除法”即要求我们从 $P = hA$ 反推出 $h$。这在普通整数上很简单，但在椭圆曲线下，不太严谨地讲，这是“难的”。

回顾一下，我们定义了一些“数字”，并定义了它们的加法和乘法运算，并且具有一些特殊的性质。恭喜你，你发明了数学中重要的抽象： 群。

## 群

正式地，一个群由以下四个属性组成：

- **封闭性**： 任意两个群元素相加，结果仍在群内；
- **结合律**： $(a + b) + c = a + (b + c)$ ；
- **单位元**：存在一个“零点”  $O$，使得 $a + O = a$；
- **逆元**：对每个元素 $a$，存在一个元素 $-a$，使得 $a + (-a) = O$。

在椭圆曲线下，所有满足曲线方程的点（包括无穷远点 $O$）构成一个群，群运算是上述定义的“点加”。若群满足交换律： $a + b = b + a$ ，我们称之为**阿贝尔群**，椭圆曲线群恰是一个阿贝尔群。

目前为止椭圆曲线被定义在实数域上：

$$
E(\mathbb{R}):\quad y^2 = x^3 + ax + b,\quad a, b \in \mathbb{R},\quad 4a^3 + 27b^2 \ne 0
$$

其中， $4a^3 + 27b^2 \ne 0$ 是为了排除一些特殊的奇奇怪怪的形状，使得曲线平滑。

实数对于应用来说很不方便，整数同样可能过大，因为最终我们需要“加密简单，解密难”。在密码学中，我们将曲线定义在有限域上，通过模运算可以实现这一点。例如：

$$
E:y2=x3+ax+b \mod p
$$

模运算又被称为时钟运算，无论时钟运行了多长时间，表盘的刻度永远在时钟的范围内。例如，现在是 $3$ 点，加上 $13$ 小时则为 $4$ 点，最终结果无论如何都被限制在一定范围内，即所有数值都限制在 $0$ 到 $p−1$ 之间的整数，这个有限域通常用 $\mathbb{F}_p$ 表示。此时曲线上的点不再是一条光滑的线，而是由离散分布的点构成，不能用传统图像来表示。虽然我们进行了取整、模运算等操作，但 $\mathbb{F}_p$ 仍然满足我们的四个群属性，即它仍然是一个阿贝尔群，我们略去证明的过程，因为这并不违反直觉。现在这个小王国已经可以正式诞生了：

$$
E(\mathbb{F}_p):\quad y^2 \equiv x^3 + ax + b \pmod{p},\quad a, b \in \mathbb{F}_p,\quad 4a^3 + 27b^2 \not\equiv 0 \pmod{p}
$$

在实数域，乘法实际上仍然可以被观察出一定的特征，从而缩小乘法逆运算的结果范围，但在经过模运算的 $\mathbb{F}_p$ 中是一个实实在在的难题，这就是经典的椭圆曲线离散对数问题。现在回到建立这个小王国的初衷：

$$
P=hG
$$

已知 $h$ 和 $G$ 可以通过乘法计算出 $P$ ，只需要把 $h$ 个 $G$ 加起来。但如果 $h$ 过大（例如 $2^{256}$）这仍然需要耗费大量资源，好在我们有双倍加法（Double-and-Add Algorithm）、滑动窗口法（Sliding Window / wNAF）等等可以简化乘法。其中双倍点加法可以将复杂度缩小到 $O(\log h)$，例如我们要计算 $13G$ :

1. $2G = G+G$
2. $3G = 2G+G$
3. $6G=3G+3G$
4. $12G=6G+6G$
5. $13G=12G+G$

现在我们拥有了简单的乘法，并且除法是难的，接下来我们只需要确定一条椭圆曲线，并选择一个点和乘数，就可以达到最终目的。但是，在 $\mathbb{F}_p$ 中成员数量是有限的，如果数目过小则会给我们带来安全问题。我们应该选择什么样的曲线，在曲线上又该选择什么样的点呢？

## 阶

对于选定的椭圆曲线，我们可以依次计算所有值，得出群成员数量。但这种方式显然是不切实际的，好在我们可以通过  Schoof's algorithm 非常简便地计算群成员数量，这也被称为群的阶。

但是 $P$ 只是椭圆曲线上的一个点，我们该怎么知道 $hP$ 有多少个结果？现在我们选取一条椭圆曲线中的点，并计算 $hP$ 的结果，看看会发生什么。我们在有限域 $\mathbb{F}_5$（模 5）上考虑椭圆曲线：

$$
E: y² ≡ x³ + x + 1 \mod 5
$$

选取曲线上的一个点：

$$
P = (0,1)
$$

让我们开始计算：

- $P = (0,1)$
- $2P = (4,2)$
- $3P = (2,1)$
- $4P = (3,4)$
- $5P = (3,1)$
- $6P = (2,4)$
- $7P = (4,3)$
- $8P = (0,4)$
- $9P = O$
- $10P = (0,1) = P$

可以观察到，在 $9P$ 处结果归 $O$ ，从而结果开始循环，该点所有结果都可以表示为：

$$
kP=(k \mod 9)P
$$

实际上，这对曲线上所有点都适用，我们可以简单地证明这一点：目前我们知道 $hP$ 的结果是有限的，但作为正整数的 $h$ 是无限的，因此，必定存在一个不相等的 $h_1$ 和 $h_2$ 使得 $h_1P=h_2P$，即： $(h_1-h_2)P=O$ 。最终，一定存在一个 $h_3=h_1-h_2$ 使得 $h_3H=O$。并且， $(h_3+k)P = O + kP = kP$。也就是说，该点所有乘积构成了一个循环子群。子群的阶等价于使得 $nP =0$ 的最小数$n$。

根据拉格朗日定理，子群的阶是父群阶的因子。即父群的阶为 $N$，子群的阶为 $n$，则 $n$ 为 $N$ 的因子。简单点说， $N$ 一定为 $n$ 的倍数，这听起来很奇怪，但我们可以用反证法简易地验证。

$H$ 是 $G$ 的子集，我们在 $H$ 之外选取一个点 $g \in G$ ，将 $g$ 加上 $H$ 中的所有元素，得到一个新的集合，即：

$$
g + H := \{ g + h : h \in H \}
$$

随后重复此过程，需要注意的是：

- 每个 $g+H$ 都是两两不交的，我们略去证明
- 由于 $H$ 中一定存在 $O$ ，所以 $g$ 被包含到了 $g+H$ 中

![image.png](/zh/gh.png)

如果拉格朗日定理不成立，那么最后将会剩下一个数量小于 $H$ 的结果集。这意味着 $H$ 中一定存在两个不同的点加上 $g$ 得到相同的结果，这是矛盾的。

现在事情好办多了，现在，我们选取一个椭圆曲线，它的阶 $N$ 足够大，并且有一个很大的因子 $n$ ，现在我们怎么找到阶为 $n$ 的基点 $G$ 呢？

## 计算基点

我们可以通过 **协因子（Cofactor）**的帮助选择这样的基点。设定我们选取的椭圆曲线的群阶为 $N$，我们期望使用一个阶为 $n$ 的子群进行加密操作。我们定义协因子为：

$$
h = \frac{N}{n}
$$

也就是说， $n$ 是我们希望使用的子群的阶，而 $N$ 是整个椭圆曲线群的阶， $h$ 是它们之间的倍数关系。由于我们要选择一个阶为 $n$ 的点 $G$，先随便选取一个曲线上的点 $P$，然后计算：

$$
G = hP
$$

此时 $G$ 很有可能是我们要找的基点，因为：

$$
nG=ghP=NP=O
$$

除非 $G=O$ ，此时我们需要重新选择一个 $P$ 。另外 $n$ 应当是个素数，否则可以分解为不同的因子，不一定是 $G$ 的阶，另外更重要的一点是素数阶是椭圆加密应用的需要。

## 总结

至此，我们完成了整个小王国的搭建：

1. 选择一条合适的椭圆曲线（满足安全参数）；
2. 使用 Schoof 等算法计算其群阶 $N$；
3. 选定一个阶为大素数 $n$ 的子群；
4. 计算协因子 $h = N / n$；
5. 任意取点 $P$，计算 $G = hP$；
6. 若 $G ≠ O$，则 $G$ 是我们想要的基点，可以开始加密系统构建。

接下来，我们就可以基于这个基点 $G$，构造密钥对、公钥加密、签名等密码学应用了。这就是现代椭圆曲线密码学的核心逻辑。