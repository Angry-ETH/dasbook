# PeerDAS

PeerDAS 是一种过渡方案，它弥补了 EIP-4844 (Proto-Danksharding)  的不足，不要求节点下载和存储全部 Blob，另一方面也不引入新的网络协议来实现完整的 Danksharding 。PeerDAS 的改进主要体现在以下几方面：

- 使用纠删码扩展 Blob；
- 形成列子网；
- 支持采样；

### **基本原理**

每个节点都需要保管最低限度的数据，例如 2 列。节点保管哪些数据列确定性地通过节点 ID 计算得到，因此任何人都可以确切地知道某个节点应该保管了哪些数据。

Blobs 被使用纠删码进行扩展，只需要行的一部分就能恢复完整行。每列数据都通过一个相应的子网进行传播，想要该列数据的节点可以订阅相应的子网。

由于确切地知道特定节点的保管数据，我们可以在本地维护足够多的多样化节点，从而间接地覆盖所有子网。当需要发起采样时，通过数据坐标逆向查找邻居，并通过 Req/Resp 协议向其发起采样请求。可以把这种直接加入的子网和间接覆盖的子网，理解为垂直和水平方向的两种扩展，它带来了很多优势：

- 重建和交叉播种： 如果节点未获得所需行/列数据，可以获取足够多的相关样本进行重建，并在子网中传播。但需要注意的是，在真正实现 2D 扩展之前，重建能力是有限的，因为无法重建列。
- 加速传播：节点在采样成功获得数据后，可以传递给没有该数据的节点，从而精准地加速数据传播。

由于确切性地知道节点应当拥有哪些数据，我们可以据此对节点进行打分，如未能按时收到数据，将降低评分，但首先需要确认是否因为网络中本身没有数据。通过同样评分我们维护了一组高可用性的邻居。

### **实施**

当前 PeerDAS 处于 Fulu 阶段，它可以被理解为 DAS 网络的初始实现。核心目标是构建一个能够支撑最小采样语义、可用性验证和基础传播的系统。

![image.png](/zh/peerdas.png)

在当前阶段中实现了 1D 的纠删码扩展，并按列映射到子网中。节点按照自身 ID 确定性地被分配若干“保管列”（custody columns）。这种列分配方式是公开、可验证且具确定性的。

除了被分配的列组合（custody group），节点也可以自行选择托管更多列，甚至可以托管全部列，形成超级全节点（super-full node）。无论托管多少列，节点都必须订阅对应的子网，并在这些子网上发布和监听列数据（DataColumnSidecar）。

当节点未能及时获得自己应托管的列时，也可以通过请求-响应协议向其他节点获取缺失的列；而如果一个节点已经拥有一半以上的列，就可以尝试重建整个矩阵，并将重建出的新列重新广播回网络，这被称为交叉播种。只要任意节点能重建数据，就可以反过来增强网络本身的数据完整性，如果金刚狼一样形成自愈式的数据传播能力。

此外，利用  custody 分配的确定性，根据每个节点的行为判断其是否履行了职责，从而进行评分。与此同时，节点会根据这些评分维护一组高可用邻居，用于优先进行采样或重建。

由于节点并不负责区块中完整的 Blob 数据，因此通过采样确保数据可用性对于当前阶段也是必要的。采样通过获取 8 个数据列来完成，获取途径有子网和同行两种。子网采样需要节点订阅相应的列子网，如果能够成功获得足够的数据，则可以认为该列可用。采样目的获得的列数据，节点没有存储和传播的责任。如果节点托管的列数量不少于 8 ，实际上已经完成了采样，不再需要额外操作。加入子网将带来更大的资源消耗，同行采样避免了这一点，节点随机确定列，并通过 Req/Resp 向其他同行请求数据。

总体来说，该阶段的 PeerDAS 以最小的改动，实现相比 Proto-Danksharding Blob 8 倍的提升。未来逐渐过度到 2D 纠删码、更好的单元采样等等，以带来更大的性能拓展。以下是更详细的对比：

| 特性 | EIP-4844 (Proto-Danksharding) | PeerDAS (Fulu 阶段) |
| --- | --- | --- |
| **节点职责** | 所有节点下载每个Blob的完整数据 | 每个节点下载由 NodeID 决定的若干数据列 |
| **最大Blob数/区块** | 最多 6 个 Blob | 最多 48 个 Blob |
| **纠删码扩展** | 无冗余编码 | 一维( 1D )纠删码扩展（每Blob扩展为两倍数据） |
| **数据采样机制** | 无抽样机制 | Custody Sampling (节点订阅并验证至少8列cell)  Peer Sampling (节点RPC请求列数据) |
| **数据恢复能力** | 无恢复能力（任一Blob缺失即不可恢复） | 只需获取50%以上的列即可恢复整个Blob数据 |
| **协议复杂度** | 较低，仅新增Blob Sidecar机制 | 中等，增加了Gossip子网结构、cell-level proof传输、Req/Resp采样协议 |
| **攻击容忍性** | 较低，任意Blob数据丢失即失效 | 中等，可容忍少量数据缺失（最高50%） |

## 参考

- [PeerDAS 相关资源](https://hackmd.io/@fradamt/peer-das-resources)
- [PeerDAS Book](https://hackmd.io/@manunalepa/peerDAS/)